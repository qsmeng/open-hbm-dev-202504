# 论坛风格重构详细计划

## 1. 数据模型设计

### 服务器配置表
```python
class ServerConfig(BaseModel):
    configs: Dict[str, Union[int, str]] = {
        "space_stability_threshold": 80,  # 地图稳定转化线
        "energy_recovery_rate": 10,       # 体力恢复时间(分钟)
        "max_energy": 256                # 最大体力值
    }
```

### 用户模型扩展
```python
class User(BaseModel):
    # 现有字段...
    experience: int = 0  # 资历
    energy: int = 256    # 体力值(上限256)
    energy_recovery_at: datetime  # 体力恢复时间
```

### 地图模型
```python
class Space(BaseModel):
    id: UUID
    type: Literal["personal", "team", "public"]
    stability: int = 100  # 稳定度(0-100)
    turns_left: int = 10   # 剩余轮次
    created_at: datetime
    updated_at: datetime
    storage_location: Literal["local", "server"]  # 存储位置

# 个人地图使用LocalStorage保存
class PersonalSpace(Space):
    storage_location: Literal["local"] = "local"
    
# 团队/公共地图使用服务器保存    
class ServerSpace(Space):
    storage_location: Literal["server"] = "server"
```

### 卡牌模型
```python
class Treasure(BaseModel):
    id: UUID
    name: str
    effect: str
    strength: int = Field(ge=0, le=256)  # 强度值(0-256)
    is_replica: bool = False  # 是否为复制品
    deviation: int = 0       # 故事线偏离度减值 
    heat: int = 0            # 热度加值
    owner_id: UUID           # 拥有者ID
```

## 2. API接口设计

### 地图API
- `GET /api/game/spaces` - 获取地图列表
- `POST /api/game/spaces/{space_id}/actions` - 提交地图行动
- `GET /api/game/spaces/{space_id}/status` - 获取地图状态

### 行动API
- `POST /api/game/actions` - 提交行动(攻击/驻防/探索/使用卡牌)
- `GET /api/game/actions/history` - 获取行动历史

### 卡牌API
- `GET /api/game/treasures` - 获取卡牌列表 
- `POST /api/game/treasures/{id}/identify` - 鉴定卡牌
- `POST /api/game/treasures/{id}/use` - 使用卡牌
- `POST /api/game/treasures/transfer` - 交易卡牌

## 3. 数据库脚本设计

### 核心数据表结构

1. **服务器配置表(server_configs)**
   - 存储游戏系统参数配置
   - 关键字段：配置键名(config_key)、配置值(config_value)、数据类型(data_type)
   - 支持动态调整游戏平衡参数

2. **空间表(spaces)**
   - 记录游戏地图空间信息
   - 包含空间类型(type)、稳定度(stability)、剩余轮次(turns_left)等核心游戏状态
   - 支持临时/稳定/固化三种空间类型

3. **用户表(users)**
   - 存储玩家账户信息
   - 包含资历(experience)、体力(energy)、等级(current_level)等成长系统数据
   - 支持多种登录方式(用户名/邮箱/手机号)

4. **卡牌表(treasures)**
   - 管理游戏卡牌数据
   - 记录卡牌效果(effect)、强度(strength)、拥有者(owner_id)
   - 支持卡牌复制(is_replica)和交易功能

5. **交互记录表**
   - 回复表(replies)：存储玩家在空间的互动内容
   - 体力日志表(energy_logs)：追踪体力消耗和恢复
   - 资历日志表(experience_logs)：记录经验值变化

### 测试数据初始化
脚本包含完整的测试数据集，覆盖：
- 3个典型玩家账户(新手/进阶/高级)
- 3种空间类型实例
- 完整的卡牌和交互记录
- 边界值测试用例

[完整SQL脚本参见：database/mysql/hbm_mysql_init.sql]

## 4. 实现路线图

### 第一阶段：基础架构
1. 实现数据模型和数据库迁移
2. 开发核心API接口
3. 实现基础状态管理

### 第二阶段：游戏逻辑
1. 实现行动处理系统
2. 开发回合结算逻辑
3. 集成AI生成功能

### 第三阶段：前端优化
1. 重构地图可视化组件
2. 优化卡牌交互界面
3. 增强状态显示面板

## 5. 测试计划

1. 单元测试：覆盖核心游戏逻辑
2. 接口测试：验证API功能
3. 集成测试：测试完整游戏流程
4. 性能测试：评估高并发场景

## 6. 游戏流程控制交互图

```mermaid
stateDiagram-v2
    [*] --> 游戏首页
    游戏首页 --> 地图加载: 自动加载
    
    state 地图加载 {
        [*] --> 加载个人地图: 从LocalStorage加载
        加载个人地图 --> 加载团队地图: 从服务器加载type='team'
        加载团队地图 --> 加载公共地图: 从服务器加载type='public'
    }
    
    state 地图选择 {
        [*] --> 个人地图: 临时地图(本地)
        个人地图 --> 创建随机地图: 选择"进入随机临时地图"
        创建随机地图 --> 个人地图: 保存到LocalStorage
        个人地图 --> 团队地图: 邀请队友(服务器)
        团队地图 --> 公共地图: 地图稳定度≥配置阈值(服务器)
        公共地图 --> 个人地图: 地图解散
    }

    state 游戏主流程 {
        [*] --> 行动选择
        行动选择 --> 攻击行动: 选择攻击
        行动选择 --> 探索行动: 选择探索
        行动选择 --> 卡牌操作: 选择卡牌
        
        state 攻击行动 {
            选择目标 --> 执行攻击
            执行攻击 --> 回合结算: 完成
        }
        
        state 探索行动 {
            探索中 --> 发现卡牌
            发现卡牌 --> 卡牌鉴定
            卡牌鉴定 --> 回合结算: 完成
        }
        
        state 卡牌操作 {
            使用卡牌 --> 效果触发
            交易卡牌 --> 确认交易
            效果触发/确认交易 --> 回合结算: 完成
        }
        
        回合结算 --> 检查轮次: 更新状态
        检查轮次 --> 行动选择: 轮次>0
        检查轮次 --> 游戏结束: 轮次≤0
    }

    地图选择 --> 游戏主流程: 选择地图
    游戏主流程 --> 地图选择: 地图不稳定度≥90
    游戏结束 --> [*]
```

### 流程说明：
1. **地图选择阶段**：
   - 玩家可选择个人/团队/公共地图
   - 地图类型影响后续游戏玩法
   - 地图稳定度决定可玩轮次

2. **行动选择**：
   - 每回合可选择攻击/探索/卡牌操作
   - 不同行动消耗不同体力值
   - 行动结果影响游戏状态

3. **回合结算**：
   - 更新地图稳定度
   - 减少剩余轮次
   - 恢复部分体力(每10分钟1点)

4. **游戏结束条件**：
   - 轮次耗尽
   - 地图稳定度≤10
   - 玩家体力耗尽
